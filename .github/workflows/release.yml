name: Build and Release

on:
  push:
    branches: [main, master]
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64

      - name: Add Windows target
        run: rustup target add x86_64-pc-windows-gnu

      - name: Build Linux
        run: |
          cargo build --release --target x86_64-unknown-linux-gnu
          cp target/x86_64-unknown-linux-gnu/release/mcj mcj-linux-x64
          chmod +x mcj-linux-x64

      - name: Build Windows
        run: |
          cargo build --release --target x86_64-pc-windows-gnu
          cp target/x86_64-pc-windows-gnu/release/mcj.exe mcj-windows-x64.exe

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
            echo "is_tag=true" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(date +'%Y%m%d')-$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
            echo "is_tag=false" >> $GITHUB_OUTPUT
          fi

      - name: Delete existing dev release
        if: steps.version.outputs.is_tag == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete dev --yes --cleanup-tag || true

      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ steps.version.outputs.is_tag }}" == "true" ]]; then
            gh release create ${{ steps.version.outputs.version }} \
              --title "Release ${{ steps.version.outputs.version }}" \
              --generate-notes \
              mcj-linux-x64 mcj-windows-x64.exe
          else
            gh release create dev \
              --title "Development Build" \
              --notes "Automated build from commit \`${{ github.sha }}\`
              
              Built: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" \
              --prerelease \
              mcj-linux-x64 mcj-windows-x64.exe
          fi
